### UTXO

### keyword

> UTXO, mempool, tranaction

### 흐름 정리

1. 사용자들이 거래 요청을 한다(트랜잭션 요청)
    - 사용자 지갑에서 트랜잭션을 만들어 네트워크로 브로드 캐스트

2. 트랜잭션 입력(txIn)은 사용자의 UTXO들을 참조한다.
    - UTXO : 블록체인 위에 흩어져 있는 아직 사용되지 않은 출력들의 집합
    - txIn : 사용자가 가진 여러 UTXO를 참조해서 입력으로 사용함

3. 트랜잭션은 여러 UTXO를 모아 필요한 금액을 보내고, 남는 금액은 새로운 txOut으로 돌려준다
    - txOut : 받는사람에게 보낼 금액 + 거스름돈 등 새로운 UTXO를 생성

4. 생성된 트랜잭션은 mempool에 저장된다.

5. 채굴자가 작업증명(PoW)을 통해 블록을 만들면서,

6. mempool에 수수료(fee)가 높은 순으로 트랜잭션을 선택해 블록에 포함한다.

7. 블록에 포함된 트랜잭션의 입력 UTXO는 소모되고, 출력은 새로운 UTXO로 추가된다.

### UTXO 예시

1. 사용자 A가 지갑에서 B에게 0.7BTC를 보내려고 한다. ( 수수료는 없다고 가정 )

2. 이때 txIn은 사용자의 UTXO들을 참조한다.  
    - A의 UTXO 목록 ( 총 보유 1.4BTC)

        | txid          | vout index | value (BTC) |
        | ------------- | ---------- | ----------- |
        | `tx100abc...` | 0          | 0.3         |
        | `tx102def...` | 1          | 0.5         |
        | `tx103jef...` | 2          | 0.6         |

3. 트랜잭션 생성 : " A가 가진 여러개의 UTXO를 txIn으로 선택해서 묶는다 "
- `vin` : `txIn`의 집합

    ``` json
    // vout index 1과 2를 사용해서 0.7이상을 맞춤 

    "vin": [
        { 
            "txid": "tx100abc...", // txIn 
            "vout": 0 // 0.3BTC
        },
        {
            "txid": "tx102def...", // txIn
            "vout": 1 // 0.5BTC
        },
    ]

    // 총 입력합 : 0.3 + 0.5
    ```

4. 트랜잭션에서 남는 금액은 새로운 txOut으로 돌려준다.
- `vout` : 수신자(B) + 거스름돈(0.1)

    ```json
    "vout": [
        {
            "value": 0.7,
            "address": "B"      // B에게 전송
        },
        {
            "value": 0.1,
            "address": "A"      // A가 다시 받는 거스름돈
        }
    ]
    // 출력 합계 : 0.7 + 0.1 = 0.8BTC
    // (fee 없음)
    ```

5. 트랜잭션은 네트워크에 브로드캐스트 되고, mempool에 담긴다.
- 전체 트랜잭션 내용 : txid + vin + vout 

    `txid` : txid = SHA256(SHA256(직렬화된 트랜잭션 데이터))

```json
{
  "txid": "tx200xyz...",
  "vin": [
    {
      "txid": "tx100abc...",
      "vout": 0
    },
    {
      "txid": "tx102def...",
      "vout": 1
    }
  ],
  "vout": [
    {
      "value": 0.7,
      "address": "B"
    },
    {
      "value": 0.1,
      "address": "A"
    }
  ]
}

```
6. 작업증명을 한 채굴자가 블록 생성시 위 트랜잭션을 포함하게 되고, 보상을 받는다
- 채굴자는 **작업증명(PoW, Proof of Work)**을 통해 블록을 생성할 수 있는 자격을 얻고, 그 블록에 **특정한 트랜잭션(수수료 높은 것들)**을 넣고, 블록 보상 + 트랜잭션 수수료를 **자신에게 보내는 트랜잭션(코인베이스)**으로 받는다.

7. 블록에 포함된 UTXO는 제거되고, 출력은 새로운 UTXO로 생성

    | txid        | vout index | value | 소유자 | 상태           |
    | ----------- | ---------- | ----- | --- | ------------ |
    | tx100abc... | 0          | 0.3   | A   | ❌ 소모됨        |
    | tx102def... | 1          | 0.5   | A   | ❌ 소모됨        |
    | tx103jef... | 2          | 0.6   | A   | ✅ 유지         |
    | tx200xyz... | 0          | 0.7   | B   | ✅ 생성됨        |
    | tx200xyz... | 1          | 0.1   | A   | ✅ 생성됨 (거스름돈) |
