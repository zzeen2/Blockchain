<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@4.16.0/dist/web3.min.js"></script>
</head>
<body>
    <div>지갑 : <span id ="ethAccount"></span></div>
    <label for ="">트랜잭션 발생시킬 계정</label><br>
    <input type="text" id = "accountAddress" placeholder="accountAddress"><br>
    <label for ="">컨트랙트 배포할 바이트 코드</label><br>
    <input type="text" id = "byteCode" placeholder="byteCode"><br>
    <button id = "sendTransaction">배포하기</button> 

    <div>카운트의 값은 : <span id = "countValue"></span></div>
</body>
<script>

    // window 브라우저의 기능
    // 확장 프로그램과 커넥션
    // ethereum 사용하는 이더계열 지갑이 들어있는 키값
    // Web3 생성자로 전달된 지갑의 커넥션을 생성
    const web3 = new Web3(window.ethereum);

    // 지갑 연결 요청

    // 원격 프로시저 호출의 형태로 요청
    // 프로토콜 eth_requestAccounts
    // 계정의 액세스 권한 요청
    window.ethereum.request({method : "eth_requestAccounts"})

    // 지갑 정보 알려줘 요청을 메타마스크로 보내기
    // 계정들 조회 

    // getAccount 계정들을 조회하는 메서드
    const getAccount = async() => {
        const accounts = await web3.eth.getAccounts();
        console.log(accounts);
        // 내가 사용중인 계정은 배열의 첫번째
        // 0번 계정을 조회하면 
        accounts.forEach(async(el, index) => {
            // getBalance 지갑의 잔액을 조회
            const balance = await web3.eth.getBalance(el);
            // 지갑의 잔액을 wei => wei 암호학자 이름에서 가져와서 
            // 소수점 
            console.log(balance)
            const eth_balance = await web3.eth.fromWei(balance)
            // 이더 단위로 표현
            console.log(eth_balance)
            if(index === 0 ) {
                ethAccount.innerHTML += `${el} 잔액 : ${eth_balance}ETH`
            }
        })
        return getAccounts([0]);
    }
    getAccount();

    // 식별자 어떤 네트워크를 사용하는지 ChainId
    // 메타마스크에 wallet_switchEthereumChain 함수 호출 요청
    const switchChainId = (chainId) => {
        window.ethereum.request({method : "wallet_switchEthereumChain", params : [{chainId}]}) 
    }
    switchChainId("0xaa35a7")
    // 네트워크 사이트 네트워크의 아이디로 제공하는 노드들
    // 1234 => 해시화 시켜서 사용
    // 웹소켓 사용해서 메타마스크의 이벤트를 구독 콜백함수 전달해서
    // 메타마스크 확장 프로그램에서 이벤트가 발생할때 호출할 함수 내용을 콜백으로 전달
    // chainChanged : 메타마스크 내부에서 호출된다. 네트워크 변환이 일어나면 실행되는 이벤트
    window.ethereum.on("chainChanged", (chainId) => {
        console.log("네트워크 변경됨 : " + chainId);
        if(chainId === "0xaa35a7"){
            console.log("내 플렛폼에서 사용하는 네트워크가 맞다")
        }else{
            alert("세폴리아 네트워크에서 사용할 수 있는 플렛폼 입니다.")
            switchChainId("0xaa35a7")
        }
    })

    // abi 어플리케이션 바이너리 인터페이스 :EVM에 실행할 메서드의 이름을 가지고 있고, 우리가 함수호출 요청 보낼때 필요한 인터페이스 값
    const abi = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"getValue","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_value","type":"uint256"}],"name":"setValue","outputs":[],"stateMutability":"nonpayable","type":"function"}]

    sendTransaction.onclick = async () => {
        // sendTransaction 트랜잭션 메세지 작성. 개인키로 서명하고 트랜잭션 발생
        const tx = await web3.eth.sendTransaction({
            from : accountAddress.value,
            gas : "3000000",
            data : "0x" + byteCode.value
        })
        console.log(tx);
    }

    // 카운트 컨트랙트 조회
    const getValue = async () => {
        // 요청 보낼때 어떤 컨트렉트 인지, 어떤 함수를 호출하는 건지
        // 트랜잭션 혹은 메세지에 담아서
        // getCodeHash
        // ABI
        // encodeFunctionCall : abi를 해시화 시키는 메서드
        const getCodeHash = await web3.eth.abi.encodeFunctionCall(abi[1], []);
        console.log(getCodeHash);
        // call과 send 
        // send 가스비가 발생하는 함수들
        // call 조회하는 메서드. 가스비가 발생하지 않는 메서드
        // call은 가스비를 지불할 사람이 없기때문에
        const tx = await web3.eth.call({to : "", data : getCodeHash})
        console.log("카운트 값은?" + tx)
        // bigint를 숫자로 변환
        // 단위를 변환해서 사용하는 작업이 많다.
        // 해시 bigint타입 변환. 그다음 10진수 문자열로 변환
        const result = await web3.utils.toBigInt(message).toString(10);
        console.log("카운트 값은 : " + result);
        countValue.innerHTML = result;
        return result;
    }
    

    const setValue = async() => {
        const value = await getValue();
        if(type === "increment"){
            const getCodeHash = await web3.eth.abi.encodeFunctionCall(abi[2], [value + 1]);
            // 가스비
            const tx = {
                from : getAccounts(),
                to : "CA 주소 넣어주기",
                data : getCodeHash,
                gas : "000000",
                gasPrice : "2100000000",
            }
            web3.eth.sendTransaction(tx);
        }else{
            if(value === 0)  return;
            const getCodeHash = await web3.eth.abi.encodeFunctionCall(abi[2], [value - 1]);
        }
    }

    getValue();
</script>
</html>